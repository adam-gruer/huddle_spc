---
title: "Huddle_SPC"
author: "A Gruer"
date: "26 October 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(qicharts2)
library(lubridate)
library(readxl)


```

```{r getdata}
huddle_data_raw <- read_xlsx("data/Copy of TABLE_HUDDLE DATA - SCREEN 01.xlsx",
                             sheet = "2018-19")


```

```{r wrangle data}
huddle_data <- huddle_data_raw %>%
                select(-X__2) %>%
                rename(kpi = X__1) %>%
                gather(key="date", value="value", -kpi) %>%
                mutate(date_original = date, #1
                       date=stringr::str_remove(date,"__1"), #2
                       date=as.numeric(date),#3
                       date=as.Date(date,origin="1899/12/30"), #4 
                       date=if_else(date_original=="1_Aug",as.Date("2018/08/01"),date)) %>% #5
                filter(date < as.Date("2018/10/27"))



#1 store orignal excel numeric date string
#2 some strings had a trailing __1 , remove that part
#3 convert excel date numeric string to a number
#4 convert number to string excle start counting form 1899/12/30
#5 one of the date columns in the original spreadsheet had 1_aug harcoded 

```

```{r}
#indexes of categoriy row headers on one day
cat_start <- 
huddle_data %>% filter(date == as.Date("2018/10/25")) %>%
  pull(value) %>%
  is.na() %>%
  which() 

#end of range of rows for each category
 cat_end <- lead(cat_start, default = 71) - 1
 #category names
 category <-  huddle_data[huddle_data$date== as.Date("2018/10/25") & is.na(huddle_data$value),1, drop = TRUE ]

# map over the three vectors, for heach header create a dataframe of the rows it applies to
 #row bind into a data frame
categories <- pmap_dfr(list(start = cat_start,
          end = cat_end,
          categor = category),
     function(start,end,category){

        tibble(row = seq(start,end) ,
               category = category)
     })

#create a lookup table between kpi and category
  
 lookup <- tibble(kpi= huddle_data[huddle_data$date== as.Date("2018/10/25") ,1 , drop = TRUE],
                 category = categories[,2,drop = TRUE])
 
 #join to huddle data on kpi and bring across the category
 #filter out category headers
 huddle_data <- huddle_data %>%
   left_join(lookup) %>%
   filter(!kpi %in% category)
      
 





  
 
```

